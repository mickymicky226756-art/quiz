<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro-Chem Quiz - ·àΩ·àç·àõ·âµ ·àò·ãµ·à®·ä≠</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* ·ä†·å†·âÉ·àã·ã≠ ·ã®·åà·åΩ ·çé·à≠·àõ·âµ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1e7e34; /* ·å•·âÅ·à≠ ·ä†·à®·äï·åì·ã¥ ·ã≥·à´ */
            transition: all 0.3s ease;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 750px;
            text-align: center;
        }

        h2 {
            color: #1e7e34;
            border-bottom: 2px solid #1e7e34;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        
        h3 {
             color: #28a745;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1e7e34;
        }

        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ·ã®·â∞·å†·âÉ·àö ·ã≥·àΩ·â¶·à≠·ãµ ·àµ·â≥·ã≠·àç */
        #user-dashboard {
            display: none;
        }
        
        /* ·ã®·àõ·àµ·â≥·ãà·âÇ·ã´ ·ä≠·çç·àç */
        #promotion-area {
            background-color: #f0fff0;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 5px solid #28a745;
            text-align: left;
        }
        
        #promotion-area h3 {
            margin-top: 0;
            color: #1e7e34;
        }
        #promotion-area p {
            line-height: 1.6;
            margin-bottom: 10px;
        }

        /* ·ã®·å•·ã´·âÑ·ãç ·ä≠·çç·àç */
        #current-quiz {
            border: 2px dashed #28a745;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #current-quiz h3 {
            color: #28a745;
            font-size: 1.5em;
        }
        
        /* ·àΩ·àç·àõ·âµ ·àò·âÄ·â†·ã´ ·âÖ·åΩ */
        #claim-prize-area {
            background-color: #ffe0b2; /* Light Orange */
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        #claim-prize-area input {
            width: calc(100% - 22px);
            margin-bottom: 10px;
        }
        #claim-prize-area button {
            background-color: #ff9800;
        }

        .subtle-link {
            font-size: 0.8em;
            color: #aaa;
            cursor: pointer;
            margin-top: 20px;
            display: block;
        }

        /* ·ã®·ä†·ãµ·àö·äï ·ã≥·àΩ·â¶·à≠·ãµ ·àµ·â≥·ã≠·àç */
        #admin-dashboard {
            display: none;
        }

        #answers-list {
            margin-top: 20px;
            text-align: left;
        }

        .answer-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .answer-details {
            flex-grow: 1;
        }

        .answer-details p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .answer-item button {
            background-color: #ffc107;
            color: #333;
            padding: 5px 10px;
        }

        .answer-item button:hover {
            background-color: #e0b400;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div id="admin-login-area">
            <h2>·ä†·ãµ·àö·äï ·àò·åç·â¢·ã´</h2>
            <div class="form-group">
                <label for="admin-password">·ã®·ã≠·àà·çç ·âÉ·àç:</label>
                <input type="password" id="admin-password" placeholder="·ã®·ã≠·àà·çç ·âÉ·àç ·ã´·àµ·åà·â°">
            </div>
            <button id="admin-login-btn">·àò·åç·â£·âµ</button>
            <p id="admin-login-message" class="alert alert-error" style="display: none;"></p>
            <a class="subtle-link" onclick="showPage('user-dashboard')">·ãà·ã∞ ·ãã·äì·ãç ·åà·åΩ ·â∞·àò·àà·àµ</a>
        </div>

        <div id="user-dashboard">
            <h2>·ã® Agro-Chem Quiz ·àΩ·àç·àõ·âµ ·àò·ãµ·à®·ä≠</h2>
            
            <div id="promotion-area">
                <h3>üí∞ ·àà·â†·àà·å† ·åà·â¢ ·ã®·ä†·åç·àÆ ·ä¨·àù ·ä¢·äï·â®·àµ·âµ·àò·äï·âµ ·àù·à≠·å´·ãé!</h3>
                <p>·â†·åç·â•·à≠·äì ·ä¨·àö·ä´·àç ·ãò·à≠·çç ·ä¢·äï·â®·àµ·âµ ·â†·àõ·ãµ·à®·åç ·â†·ã®·âÄ·äë ·âµ·à≠·çç ·ã´·åç·äô! ·ä†·àµ·â∞·àõ·àõ·äù ·ä•·äì ·ä†·ãã·å≠ ·ã®·àÜ·äê·ãç·äï ·ã®·ä†·åç·àÆ ·ä¨·àù ·àò·ãµ·à®·ä≠ ·ã≠·âÄ·àã·âÄ·àâ·ç¢</p>
                <p>·â†·âµ·äï·àπ 500 ·â•·à≠ ·ä¢·äï·â®·àµ·âµ ·â†·àõ·ãµ·à®·åç ·ä•·àµ·ä® **9% ·ãï·àà·â≥·ãä ·âµ·à≠·çç** ·àõ·åç·äò·âµ ·ã≠·åÄ·àù·à©·ç¢ ·ä†·àÅ·äï ·ã≠·àò·ãù·åà·â°·äì ·ã®·çã·ã≠·äì·äï·àµ ·äê·çÉ·äê·âµ ·àò·äï·åà·ãµ ·ã≠·åÄ·àù·à©!</p>
            </div>
            
            <div id="current-quiz">
                <h3 id="question-text">·ä†·ã≤·àµ ·å•·ã´·âÑ ·â†·àò·å†·â†·âÖ ·àã·ã≠...</h3>
                <p id="quiz-status" class="alert alert-success">·å•·ã´·âÑ·ãç ·â†·ã®·àù·àΩ·â± ·ä®2:30 ·ä•·àµ·ä® 3:00 ·à∞·ãì·âµ ·ã≠·âÄ·à≠·â£·àç·ç¢</p>
            </div>
            
            <div id="quiz-interaction-area">
                
                <div id="answer-submission-form" style="display: none;">
                    <form id="submit-answer-form">
                        <div class="form-group">
                            <label for="user-answer">·àò·àç·àµ·ãé:</label>
                            <input type="text" id="user-answer" placeholder="·àò·àç·àµ·ãé·äï ·ä•·ãö·àÖ ·ã´·àµ·åà·â°" required>
                        </div>
                        <button type="submit">·àò·àç·àµ ·àã·ä≠</button>
                        <p id="answer-message" class="alert" style="display: none;"></p>
                    </form>
                </div>
                
                <p id="waiting-message" class="alert" style="display: none;"></p>

                <div id="claim-prize-area" style="display: none;">
                    <h3>üéâ ·ä•·äï·ä≥·äï ·ã∞·àµ ·ä†·àà·ãé·âµ! ·àò·àç·àµ·ãé ·â∞·à®·åã·åç·åß·àç!</h3>
                    <p>·àΩ·àç·àõ·âµ·ãé·äï 20 ·â•·à≠ ·àà·àõ·åç·äò·âµ·ç£ ·â†·ä†·åç·àÆ ·ä¨·àù ·ã®·â∞·àò·ãò·åà·â°·â†·âµ·äï ·àµ·àç·ä≠ ·âÅ·å•·à≠ ·ã´·àµ·åà·â°·ç¢</p>
                    <form id="claim-form">
                        <input type="text" id="claim-phone" placeholder="09XXXXXXXX" required pattern="[0-9]{10}">
                        <button type="submit">20 ·â•·à≠ ·â∞·à∏·àà·àò·äù</button>
                        <p id="claim-message" class="alert" style="display: none;"></p>
                    </form>
                </div>
            </div>
            
            <a class="subtle-link" onclick="showPage('admin-login-area')">·ä†·ãµ·àö·äï ·àò·åç·â¢·ã´</a>
        </div>

        <div id="admin-dashboard">
            <h2>·ä†·ãµ·àö·äï ·ã≥·àΩ·â¶·à≠·ãµ</h2>
            <button id="admin-logout-btn" style="float: right; background-color: #dc3545;">·ãç·å£</button>
            
            <div style="clear: both;">
                <h3>·ä†·ã≤·àµ ·å•·ã´·âÑ ·ã≠·çç·å†·à©</h3>
                <form id="create-quiz-form">
                    <div class="form-group">
                        <label for="new-question">·å•·ã´·âÑ:</label>
                        <textarea id="new-question" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="correct-answer">·âµ·ä≠·ä≠·àà·äõ ·àò·àç·àµ:</label>
                        <input type="text" id="correct-answer" required>
                    </div>
                    <button type="submit">·å•·ã´·âÑ ·àà·å•·çç</button>
                    <p id="question-post-message" class="alert" style="display: none;"></p>
                </form>
            </div>
            
            <hr style="margin: 30px 0;">
            <h3>·ã®·â∞·àã·ä© ·àò·àç·à∂·âΩ ·ãù·à≠·ãù·à≠</h3>
            <div id="answers-list">
                <p>·àù·äï·àù ·àò·àç·àµ ·ä†·àç·â∞·àã·ä®·àù...</p>
            </div>
        </div>

    </div>

    <script>
        // ************************** 1. Firebase Configuration **************************
        const firebaseConfig = {
            apiKey: "AIzaSyDu7AqPVMcvSR-hA6VO7zfVCd9XhJvQFcs",
            authDomain: "mmmm-c2cc3.firebaseapp.com",
            databaseURL: "https://mmmm-c2cc3-default-rtdb.firebaseio.com",
            projectId: "mmmm-c2cc3",
            storageBucket: "mmmm-c2cc3.firebasestorage.app",
            messagingSenderId: "1064370711409",
            appId: "1:1064370711409:web:05787d6231bc721c6aa4d0",
            measurementId: "G-MZ7FM1D607"
        };
        
        // Firebase ·ä†·àµ·åÄ·àù·à≠
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // ************************** 2. Global Variables and Setup **************************
        const ADMIN_PASSWORD = 'agrochemadmin2025'; // ·ã®·ä†·ãµ·àö·äï ·ã®·ã≠·àà·çç ·âÉ·àç
        const PRIZE_AMOUNT = 20; // ·ã®·àö·à∞·å†·ãç ·ã®·àΩ·àç·àõ·âµ ·â•·à≠
        
        let currentQuestion = null; 
        
        // Local Storage·äï ·â†·àò·å†·âÄ·àù ·ã®·ä†·àÅ·äë·äï ·ã®·â∞·å†·âÉ·àö ·àò·àç·àµ ·àò·àà·ã´ ·âÅ·å•·à≠ ·àò·ã´·ãù
        let myAnswerKey = localStorage.getItem('myAnswerKey'); 
        // ·àò·àç·à± ·ã®·â∞·àã·ä®·â†·âµ·äï ·ã®·å•·ã´·âÑ ·àò·àà·ã´ ·âÅ·å•·à≠ ·àò·ã´·ãù
        let lastQuestionId = localStorage.getItem('lastQuestionId'); 
        
        const adminLoginArea = document.getElementById('admin-login-area');
        const userDashboard = document.getElementById('user-dashboard');
        const adminDashboard = document.getElementById('admin-dashboard');

        // ·åà·åæ·âΩ·äï ·ã®·àö·âÄ·ã´·ã≠·à≠ ·â∞·åç·â£·à≠
        function showPage(pageId) {
            adminLoginArea.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            
            const page = document.getElementById(pageId);
            if (page) {
                page.style.display = 'block';
            }
        }

        // ************************** 3. Admin Logic **************************
        
        // Admin Login
        document.getElementById('admin-login-btn').addEventListener('click', () => {
            const password = document.getElementById('admin-password').value;
            const messageEl = document.getElementById('admin-login-message');
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                showPage('admin-dashboard');
                messageEl.style.display = 'none';
                displayAnswers(); 
            } else {
                messageEl.textContent = '·ã®·ã≠·àà·çç ·âÉ·àç·ãé ·âµ·ä≠·ä≠·àç ·ä†·ã≠·ã∞·àà·àù·ç¢';
                messageEl.style.display = 'block';
            }
        });

        // Admin Logout
        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('isAdminLoggedIn');
            showPage('user-dashboard');
        });

        // Post Question (·å•·ã´·âÑ ·àà·å•·çç) 
        document.getElementById('create-quiz-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const question = document.getElementById('new-question').value.trim();
            const answer = document.getElementById('correct-answer').value.trim();
            const messageEl = document.getElementById('question-post-message');
            
            if (!question || !answer) {
                messageEl.className = 'alert alert-error';
                messageEl.textContent = '·å•·ã´·âÑ·äì ·àò·àç·àµ ·àõ·àµ·åà·â£·âµ ·åç·ãµ ·äê·ãç·ç¢';
                messageEl.style.display = 'block';
                return;
            }
            
            messageEl.style.display = 'none';
            messageEl.textContent = '';

            // ·ä†·ã≤·àµ ·ã®·å•·ã´·âÑ ·àò·àà·ã´ ·âÅ·å•·à≠ ·àò·çç·å†·à≠
            const newQuestionId = Date.now().toString(); 

            db.ref('quiz/current_question').set({
                id: newQuestionId, // ·ä†·ã≤·à±·äï ·àò·àà·ã´ ·âÅ·å•·à≠ ·àõ·àµ·åà·â£·âµ
                question: question,
                correct_answer: answer.toLowerCase(), 
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                messageEl.className = 'alert alert-success';
                messageEl.textContent = '‚úÖ ·å•·ã´·âÑ·ãç ·â†·àµ·ä¨·âµ ·â∞·àà·å•·çè·àç!';
                messageEl.style.display = 'block';
                
                document.getElementById('new-question').value = '';
                document.getElementById('correct-answer').value = '';
                
                // ·ä†·ã≤·àµ ·å•·ã´·âÑ ·à≤·àà·å†·çç ·ã®·ãµ·àÆ ·ã®·â∞·å†·âÉ·àö ·àò·à®·åÉ·ãé·âΩ·äï ·àõ·åΩ·ã≥·âµ
                localStorage.removeItem('myAnswerKey');
                localStorage.setItem('lastQuestionId', newQuestionId);
                myAnswerKey = null;
                lastQuestionId = newQuestionId;
                
                // ·ã®·ãµ·àÆ ·àò·àç·à∂·âΩ·äï ·àõ·å•·çã·âµ
                db.ref('quiz/answers').remove();
            }).catch(error => {
                console.error("Firebase Question Post Error:", error);
                messageEl.className = 'alert alert-error';
                messageEl.textContent = `‚ùå ·å•·ã´·âÑ·ãç·äï ·àò·àà·å†·çç ·ä†·àç·â∞·âª·àà·àù! ·àµ·àÖ·â∞·âµ: ${error.message}.`;
                messageEl.style.display = 'block';
            });
        });

        // ·àò·àç·à±·äï ·âµ·ä≠·ä≠·àç ·àò·àÜ·äë·äï ·ã®·àö·ã´·à®·åã·åç·å• ·â∞·åç·â£·à≠ (Admin)
        function verifyAnswer(answerKey) {
            if (!confirm('·ã≠·àÖ·äï·äï ·àò·àç·àµ ·ä•·äï·ã∞ ·âµ·ä≠·ä≠·àà·äõ ·ä†·à®·åã·åç·å†·ãç ·â∞·å†·âÉ·àö·ãç ·àΩ·àç·àõ·âµ ·ä•·äï·ã≤·ãà·àµ·ãµ ·ãà·ã∞ ·àò·ãµ·à®·ä© ·àò·àã·ä≠ ·ã≠·çà·àç·åã·àâ?')) {
                return;
            }
            
            db.ref(`quiz/answers/${answerKey}`).update({
                is_verified: true,
                verified_timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                alert('‚úÖ ·àò·àç·à± ·â†·â∞·à≥·ä´ ·àÅ·äî·â≥ ·â∞·à®·åã·åç·åß·àç·ç¢ ·â∞·å†·âÉ·àö·ãç ·ä†·àÅ·äï ·àµ·àç·ä≠ ·âÅ·å•·à©·äï ·ä†·àµ·åà·â•·â∂ ·àΩ·àç·àõ·âµ ·ã≠·ãà·àµ·ã≥·àç!');
            }).catch(error => {
                alert(`‚ùå ·àõ·à®·åã·åà·å• ·ä†·àç·â∞·âª·àà·àù: ${error.message}`);
                console.error("Verification Error:", error);
            });
        }


        // ·àò·àç·à∂·âΩ·äï ·â†·ä•·ãç·äê·â∞·äõ ·åä·ãú ·àõ·à≥·ã®·âµ (Admin)
        function displayAnswers() {
            const answersList = document.getElementById('answers-list');
            
            db.ref('quiz/answers').on('value', (snapshot) => {
                answersList.innerHTML = '';
                if (!snapshot.exists()) {
                    answersList.innerHTML = '<p>·àù·äï·àù ·àò·àç·àµ ·ä†·àç·â∞·àã·ä®·àù...</p>';
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const answerData = childSnapshot.val();
                    const key = childSnapshot.key;
                    
                    const item = document.createElement('div');
                    item.className = 'answer-item';

                    let adminActionArea = '';
                    
                    if (answerData.is_winner) {
                        // ·ä†·à∏·äì·çä ·ä®·àÜ·äê
                        item.style.backgroundColor = '#ccffcc'; 
                        adminActionArea = `<div>** ·â∞·à∏·àç·àü·àç! (${answerData.winner_phone}) **</div>`;
                    } else if (answerData.is_verified) {
                        // ·ä®·â∞·à®·åã·åà·å† (·â∞·å†·âÉ·àö·ãç ·àµ·àç·ä©·äï ·ä•·àµ·ä™·ã´·àµ·â∞·ä´·ä≠·àç ·â†·àò·å†·â†·âÖ)
                        item.style.backgroundColor = '#fffacd'; 
                        adminActionArea = `<div>** ·â†·àò·å†·â£·â†·âÖ ·àã·ã≠ (·àà·â∞·å†·âÉ·àö·ãç ·â∞·àç·ä≥·àç) **</div>`;
                    } else {
                        // ·ä†·ã≤·àµ ·àò·àç·àµ (·àà·àõ·à®·åã·åà·å•)
                        adminActionArea = `<button onclick="verifyAnswer('${key}')">·àò·àç·à± ·âµ·ä≠·ä≠·àç ·äê·ãç ·ä†·à®·åã·åç·å•</button>`;
                    }

                    const date = new Date(answerData.timestamp).toLocaleTimeString('am-ET');

                    item.innerHTML = `
                        <div class="answer-details">
                            <p><strong>·àò·àç·àµ:</strong> ${answerData.answer}</p>
                            <p><strong>·ã®·â∞·àã·ä®·â†·âµ ·à∞·ãì·âµ:</strong> ${date}</p>
                            ${answerData.is_winner && answerData.winner_phone ? `<p style="color: green;"><strong>·ä†·à∏·äì·çä ·àµ·àç·ä≠:</strong> ${answerData.winner_phone}</p>` : ''}
                        </div>
                        ${adminActionArea}
                    `;
                    
                    // ·ä†·à∏·äì·çä·ãé·âΩ·äï ·ãà·ã∞ ·àã·ã≠ ·àõ·ãµ·à®·åç
                    if (answerData.is_winner || answerData.is_verified) {
                        answersList.prepend(item);
                    } else {
                        answersList.appendChild(item);
                    }
                });
            });
        }
        
        // ************************** 4. User Logic **************************

        // ·ã®·â∞·å†·âÉ·àö·ãç·äï ·ã≥·àΩ·â¶·à≠·ãµ ·àÅ·äî·â≥ ·ã®·àö·âÜ·å£·å†·à≠ ·â∞·åç·â£·à≠
        function updateUserQuizState(state) {
            const quizForm = document.getElementById('answer-submission-form');
            const waitingMsg = document.getElementById('waiting-message');
            const claimArea = document.getElementById('claim-prize-area');
            const currentQuiz = document.getElementById('current-quiz');

            // ·àÅ·àâ·äï·àù ·ã∞·â•·âÖ
            quizForm.style.display = 'none';
            waitingMsg.style.display = 'none';
            claimArea.style.display = 'none';
            currentQuiz.style.display = 'block';

            if (state === 'active') {
                // ·å•·ã´·âÑ·ãç ·ä†·àà·ç£ ·àò·àç·àµ ·àò·àµ·å´ ·âÖ·åΩ ·ä†·à≥·ã≠
                quizForm.style.display = 'block';
            } else if (state === 'waiting') {
                // ·àò·àç·àµ ·àç·ä≥·àç·ç£ ·ä†·ãµ·àö·äï ·ä•·àµ·ä™·ã´·à®·åã·åç·å• ·ãµ·à®·àµ ·å†·â•·âÖ
                waitingMsg.textContent = '‚è± ·àò·àç·àµ·ãé ·â∞·àç·ä≥·àç·ç¢ ·ä†·ãµ·àö·äï ·ä•·àµ·ä™·çà·âµ·àΩ ·ãµ·à®·àµ ·â†·ãö·àÅ ·åà·åΩ ·ã≠·å†·â•·âÅ...';
                waitingMsg.className = 'alert alert-error'; 
                waitingMsg.style.display = 'block';
            } else if (state === 'claim') {
                // ·ä†·ãµ·àö·äï ·ä†·à®·åã·åç·åß·àç·ç£ ·ã®·àµ·àç·ä≠ ·âÅ·å•·à≠ ·âÖ·åΩ ·ä†·à≥·ã≠
                claimArea.style.display = 'block';
            } else if (state === 'awarded') {
                 // ·àΩ·àç·àõ·âµ ·â∞·à∞·å•·â∑·àç
                 waitingMsg.textContent = 'üéâ ·ä•·äï·ä≥·äï ·ã∞·àµ ·ä†·àà·ãé·âµ! 20 ·â•·à≠ ·àÇ·à≥·â•·ãé ·àã·ã≠ ·åà·â¢ ·àÜ·äó·àç·ç¢';
                 waitingMsg.className = 'alert alert-success'; 
                 waitingMsg.style.display = 'block';
            } else if (state === 'inactive') {
                // ·å•·ã´·âÑ ·ã®·àà·àù
                currentQuiz.style.display = 'block';
            }
        }
        
        // ·ã®·â∞·å†·âÉ·àö·ãç·äï ·àò·àç·àµ ·àÅ·äî·â≥ ·ã®·àö·ä®·â≥·â∞·àç ·â∞·åç·â£·à≠ (Firebase Listener)
        function listenToMyAnswerStatus() {
            if (!myAnswerKey || !currentQuestion || currentQuestion.id !== lastQuestionId) {
                return;
            }
            
            // ·ã®·â∞·å†·âÉ·àö·ãç·äï ·àç·ã© ·àò·àç·àµ ·âÅ·àç·çç ·â•·âª ·àõ·ã≥·àò·å•
            db.ref(`quiz/answers/${myAnswerKey}`).on('value', (snapshot) => {
                const answerData = snapshot.val();
                
                if (!answerData) {
                    // ·àò·àç·à± ·ä®·â∞·à∞·à®·ãò (·àà·àù·à≥·àå ·ä†·ãµ·àö·äï ·ä†·ã≤·àµ ·å•·ã´·âÑ ·àà·å•·çè·àç)
                    localStorage.removeItem('myAnswerKey');
                    myAnswerKey = null;
                    if (currentQuestion) {
                         updateUserQuizState('active');
                    }
                    return;
                }

                if (answerData.is_winner) {
                    // ·â∞·à∏·àç·àü·àç
                    updateUserQuizState('awarded');
                } else if (answerData.is_verified) {
                    // ·â∞·à®·åã·åç·åß·àç·ç£ ·àΩ·àç·àõ·âµ ·ä•·äï·ã≤·ãà·àµ·ãµ ·çç·âÄ·ãµ
                    updateUserQuizState('claim');
                } else {
                    // ·â†·àò·å†·â†·âÖ ·àã·ã≠
                    updateUserQuizState('waiting');
                }
            });
        }

        // ·àò·àç·àµ ·àò·àã·ä≠ (User) - ·àµ·àç·ä≠ ·âÅ·å•·à≠ ·â∞·ãà·åç·ã∑·àç
        document.getElementById('submit-answer-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentQuestion) {
                 alert('·ã≠·âÖ·à≠·â≥! ·ä†·àÅ·äï ·äï·âÅ ·å•·ã´·âÑ ·ã®·àà·àù·ç¢');
                 return;
            }
            
            const answer = document.getElementById('user-answer').value.trim();
            const messageEl = document.getElementById('answer-message');
            
            // ·ä†·äï·ãµ ·åä·ãú ·â•·âª ·àò·àò·àà·àµ ·ä•·äï·ã≤·âΩ·àç ·àò·ä®·àç·ä®·àç
            if (myAnswerKey && currentQuestion.id === lastQuestionId) {
                messageEl.className = 'alert alert-error';
                messageEl.textContent = '·àò·àç·àµ·ãé·äï ·ä†·àµ·âÄ·ãµ·àò·ãç ·àç·ä®·ãã·àç·ç¢ ·ä•·â£·ä≠·ãé ·ã®·ä†·ãµ·àö·äï ·àõ·à®·åã·åà·å´ ·ã≠·å†·â•·âÅ·ç¢';
                messageEl.style.display = 'block';
                return;
            }
            
            if (!answer) {
                messageEl.className = 'alert alert-error';
                messageEl.textContent = '·àò·àç·àµ ·àõ·àµ·åà·â£·âµ ·ä†·àà·â•·ãé·âµ·ç¢';
                messageEl.style.display = 'block';
                return;
            }
            
            messageEl.style.display = 'none';
            messageEl.textContent = '';

            // ·àò·àç·àµ ·àò·àã·ä≠ ·ä•·äì ·àç·ã© ·àò·àà·ã´ ·âÅ·å•·à≠ (key) ·àõ·åç·äò·âµ
            const newAnswerRef = db.ref('quiz/answers').push();
            newAnswerRef.set({
                question_id: currentQuestion.id, // ·ä®·å•·ã´·âÑ·ãç ·åã·à≠ ·àõ·åà·äì·äò·âµ
                answer: answer,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                is_verified: false,
                is_winner: false
            }).then(() => {
                // ·àò·àà·ã´ ·âÅ·å•·à©·äï ·â† Local Storage ·àõ·àµ·âÄ·àò·å•
                myAnswerKey = newAnswerRef.key;
                localStorage.setItem('myAnswerKey', myAnswerKey);
                localStorage.setItem('lastQuestionId', currentQuestion.id);

                messageEl.className = 'alert alert-success';
                messageEl.textContent = '‚úÖ ·àò·àç·àµ·ãé ·â†·â∞·à≥·ä´ ·àÅ·äî·â≥ ·â∞·àç·ä≥·àç·ç¢ ·ä†·ãµ·àö·äï ·ä•·àµ·ä™·ã´·à®·åã·åç·å• ·ãµ·à®·àµ ·ã≠·å†·â•·âÅ!';
                messageEl.style.display = 'block';
                document.getElementById('user-answer').value = ''; 
                
                // ·àÅ·äî·â≥·ãç·äï ·ãà·ã∞ ·àò·å†·â†·âÖ ·àò·âÄ·ã®·à≠
                updateUserQuizState('waiting'); 
                
                // ·ã®·â∞·àã·ä®·ãç·äï ·àò·àç·àµ ·àÅ·äî·â≥ ·àò·ä®·â≥·â∞·àç ·àò·åÄ·àò·à≠
                listenToMyAnswerStatus();

            }).catch(error => {
                messageEl.className = 'alert alert-error';
                messageEl.textContent = `‚ùå ·àò·àç·àµ·ãé·äï ·àò·àã·ä≠ ·ä†·àç·â∞·âª·àà·àù: ${error.message}`;
                messageEl.style.display = 'block';
            });
        });
        
        // ·àΩ·àç·àõ·âµ ·àò·âÄ·â†·ã´ ·âÖ·åΩ ·àò·àã·ä≠ (User)
        document.getElementById('claim-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!myAnswerKey) {
                alert('·àµ·àÖ·â∞·âµ: ·àù·äï·àù ·ã®·â∞·à®·åã·åà·å† ·àò·àç·àµ ·ã®·àà·ãé·âµ·àù·ç¢');
                return;
            }
            
            const phone = document.getElementById('claim-phone').value.trim();
            const messageEl = document.getElementById('claim-message');
            
            if (phone.length !== 10 || !/^\d+$/.test(phone)) {
                messageEl.className = 'alert alert-error';
                messageEl.textContent = '·ä•·â£·ä≠·ãé ·âµ·ä≠·ä≠·àà·äõ 10 ·ä†·àÉ·ãù ·àµ·àç·ä≠ ·âÅ·å•·à≠ ·ã´·àµ·åà·â°!';
                messageEl.style.display = 'block';
                return;
            }
            
            messageEl.style.display = 'none';
            messageEl.textContent = '';
            
            // 1. ·àΩ·àç·àõ·â± ·âÄ·ã∞·àù ·â•·àé ·àò·à∞·å†·â±·äï ·àõ·à®·åã·åà·å•
            db.ref(`quiz/answers/${myAnswerKey}`).once('value').then(snapshot => {
                const answerData = snapshot.val();
                if (answerData && answerData.is_winner) {
                    alert('·ã≠·àÖ ·àΩ·àç·àõ·âµ ·âÄ·ã∞·àù ·à≤·àç ·â∞·ãà·àµ·ã∑·àç·ç¢');
                    updateUserQuizState('awarded');
                    return;
                }
                
                // 2. ·àΩ·àç·àõ·âµ ·àò·àµ·å†·âµ
                awardPrizeToUser(phone, myAnswerKey, messageEl);
                
            }).catch(error => {
                messageEl.className = 'alert alert-error';
                messageEl.textContent = `‚ùå ·àµ·àÖ·â∞·âµ: ${error.message}`;
                messageEl.style.display = 'block';
            });
        });

        // ·àΩ·àç·àõ·â±·äï ·ãà·ã∞ ·àÇ·à≥·â• ·ã®·àö·å®·àù·à≠ ·â∞·åç·â£·à≠
        function awardPrizeToUser(phoneNumber, answerKey, messageEl) {
            const userRef = db.ref(`users/${phoneNumber}`);

            // ·â∞·å†·âÉ·àö·ãç ·àò·äñ·à©·äï ·àõ·à®·åã·åà·å•
            userRef.once('value').then(userSnapshot => {
                if (!userSnapshot.exists()) {
                    messageEl.className = 'alert alert-error';
                    messageEl.textContent = `‚ùå ·àµ·àÖ·â∞·âµ: ·àµ·àç·ä≠ ·âÅ·å•·à≠ ${phoneNumber} ·â†·ä¢·äï·â®·àµ·âµ·àò·äï·âµ ·ã≥·â≥·â§·ãù·ãé ·àã·ã≠ ·ä†·àç·â∞·åà·äò·àù·ç¢ ·â†·âµ·ä≠·ä≠·àç ·àò·àò·ãù·åà·â•·ãé·äï ·ã´·à®·åã·åç·å°·ç¢`;
                    messageEl.style.display = 'block';
                    return;
                }

                // 1. ·ã®·ä†·àÅ·äë·äï ·àÇ·à≥·â• ·àõ·äï·â†·â• ·ä•·äì 20 ·â•·à≠ ·àò·å®·àò·à≠ (Transaction)
                userRef.child('balance').transaction((currentBalance) => {
                    const newBalance = (currentBalance || 0) + PRIZE_AMOUNT;
                    return newBalance;
                }, (error, committed, snapshot) => {
                    if (error) {
                        messageEl.className = 'alert alert-error';
                        messageEl.textContent = `‚ùå ·ã®·àí·à≥·â• ·àò·å®·àò·à≠ ·àµ·àÖ·â∞·âµ: ${error.message}`;
                    } else if (!committed) {
                        messageEl.className = 'alert alert-error';
                        messageEl.textContent = '‚ùå ·ã®·àí·à≥·â• ·àò·å®·àò·à≠ ·ä†·àç·â∞·à≥·ä´·àù·ç¢ ·ã≥·åç·àù ·ã≠·àû·ä≠·à©·ç¢';
                    } else {
                        // 2. ·â†·â∞·à≥·ä´ ·àÅ·äî·â≥ ·à≤·à∏·àà·àù ·àò·àç·à±·äï ·àò·ãù·åà·â• ·àã·ã≠ ·àù·àç·ä≠·âµ ·àõ·ãµ·à®·åç
                        db.ref(`quiz/answers/${answerKey}`).update({
                            is_winner: true,
                            winner_phone: phoneNumber,
                            awarded_timestamp: firebase.database.ServerValue.TIMESTAMP
                        }).then(() => {
                            messageEl.className = 'alert alert-success';
                            messageEl.textContent = `üéâ ·ä•·äï·ä≥·äï ·ã∞·àµ ·ä†·àà·ãé·âµ! ${PRIZE_AMOUNT} ·â•·à≠ ·ãà·ã∞ ·àÇ·à≥·â•·ãé ·åà·â¢ ·àÜ·äó·àç!`;
                            updateUserQuizState('awarded');
                        }).catch(err => {
                            messageEl.className = 'alert alert-error';
                            messageEl.textContent = `‚ö†Ô∏è ·àΩ·àç·àõ·â± ·åà·â•·â∑·àç·ç£ ·äê·åà·à≠ ·åç·äï ·àÅ·äî·â≥·ãç·äï ·àù·àç·ä≠·âµ ·àõ·ãµ·à®·åç ·ä†·àç·â∞·âª·àà·àù·ç° ${err.message}`;
                            updateUserQuizState('awarded');
                        });
                    }
                    messageEl.style.display = 'block';
                });

            }).catch(error => {
                messageEl.className = 'alert alert-error';
                messageEl.textContent = `‚ùå ·ã®·â∞·å†·âÉ·àö ·ã≥·â≥ ·àõ·åç·äò·âµ ·ä†·àç·â∞·âª·àà·àù: ${error.message}`;
                messageEl.style.display = 'block';
            });
        }

        // ************************** 5. Initialization **************************
        
        // ·åà·åπ ·à≤·ä®·çà·âµ ·ã®·â∞·å†·âÉ·àö·ãç·äï ·àÅ·äî·â≥ ·ã®·àö·ãà·àµ·äï ·â∞·åç·â£·à≠
        function initializeUserDashboard() {
            if (!currentQuestion) {
                updateUserQuizState('inactive'); 
                return;
            }

            const storedAnswerKey = localStorage.getItem('myAnswerKey');
            const storedQuestionId = localStorage.getItem('lastQuestionId');

            if (storedAnswerKey && storedQuestionId === currentQuestion.id) {
                myAnswerKey = storedAnswerKey;
                // ·ã®·àõ·à®·åã·åà·å´ ·àÇ·ã∞·â±·äï ·ã≠·åÄ·àù·à´·àç (·ä®·àò·åÄ·àò·à™·ã´·ãç ·åÄ·àù·àÆ ·àÅ·äî·â≥·ãç·äï ·ã≠·ãà·àµ·äì·àç)
                listenToMyAnswerStatus(); 
                updateUserQuizState('waiting'); 
            } else {
                // ·ä†·ã≤·àµ ·å•·ã´·âÑ ·äê·ãç ·ãà·ã≠·àù ·àò·àç·àµ ·ä†·àç·à∞·å†·àù
                localStorage.removeItem('myAnswerKey');
                myAnswerKey = null;
                updateUserQuizState('active'); 
            }
        }

        // ·å•·ã´·âÑ·ãç ·à≤·àà·âÄ·âÖ/·à≤·âÄ·ã®·à≠ ·ã®·àö·äê·à≥ Listener
        db.ref('quiz/current_question').on('value', (snapshot) => {
            const questionEl = document.getElementById('question-text');
            const statusEl = document.getElementById('quiz-status');
            
            if (snapshot.exists()) {
                currentQuestion = snapshot.val();
                questionEl.textContent = `‚ùì ·å•·ã´·âÑ·ãç: ${currentQuestion.question}`;
                statusEl.className = 'alert alert-error';
                statusEl.textContent = '·çà·å•·äê·ãç ·ã≠·àò·àç·à±! ·àò·àç·àµ ·ä®·àã·ä© ·â†·äã·àã ·àõ·à®·àù ·ä†·ã≠·âΩ·àâ·àù·ç¢';
            } else {
                currentQuestion = null;
                questionEl.textContent = '·ä†·ã≤·àµ ·å•·ã´·âÑ ·â†·àò·å†·â†·âÖ ·àã·ã≠...';
                statusEl.className = 'alert alert-success';
                statusEl.textContent = '·å•·ã´·âÑ·ãç ·â†·ã®·àù·àΩ·â± ·ä®2:30 ·ä•·àµ·ä® 3:00 ·à∞·ãì·âµ ·ã≠·âÄ·à≠·â£·àç·ç¢ ·ã≠·å†·â•·âÅ!';
            }
            
            // ·ã®·å•·ã´·âÑ·ãç ·ã≥·â≥ ·à≤·âÄ·ã®·à≠ ·ã®·â∞·å†·âÉ·àö·ãç·äï ·àÅ·äî·â≥ ·àõ·àµ·â∞·ä´·ä®·àç
            if (document.getElementById('user-dashboard').style.display === 'block') {
                 initializeUserDashboard();
            }
        });

        // ·åà·åπ ·à≤·ä®·çà·âµ ·àò·åÄ·àò·à™·ã´ ·ã®·àö·â≥·ã®·ãç
        window.onload = () => {
            const isAdminLoggedIn = sessionStorage.getItem('isAdminLoggedIn') === 'true';
            if (isAdminLoggedIn) {
                showPage('admin-dashboard');
                displayAnswers();
            } else {
                showPage('user-dashboard');
                // initializeUserDashboard ·ã®·àö·å†·à´·ãç ·â† current_question listener ·ä†·àõ·ä´·äù·äê·âµ ·äê·ãç·ç¢
            }
        };

    </script>
</body>
</html>